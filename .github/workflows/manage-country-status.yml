name: Manage Country Status

on:
  workflow_dispatch:
    inputs:
      country_code:
        description: 'ISO3 country code (e.g., TWN, DOM, VNM)'
        required: true
        type: string
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - activate
          - deactivate

jobs:
  manage-country-status:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ${{ inputs.action == 'activate' && 'Activate' || 'Deactivate' }} country
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          python -c "
          from country_utils import activate_country, deactivate_country
          if '${{ inputs.action }}' == 'activate':
              activate_country('${{ inputs.country_code }}')
              print('✓ Country ${{ inputs.country_code }} has been activated')
          else:
              deactivate_country('${{ inputs.country_code }}')
              print('✓ Country ${{ inputs.country_code }} has been deactivated')
          "
      
      - name: Verify status
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        run: |
          python -c "
          from snowflake_utils import get_snowflake_connection
          import pandas as pd
          
          conn = get_snowflake_connection()
          query = '''
              SELECT COUNTRY_CODE, COUNTRY_NAME, ACTIVE
              FROM PIPELINE_COUNTRIES
              WHERE COUNTRY_CODE = '${{ inputs.country_code }}'
          '''
          df = pd.read_sql(query, conn)
          conn.close()
          
          if len(df) > 0:
              row = df.iloc[0]
              status = 'ACTIVE' if row['ACTIVE'] else 'INACTIVE'
              print(f'Country: {row[\"COUNTRY_CODE\"]} ({row[\"COUNTRY_NAME\"]})')
              print(f'Status: {status}')
          else:
              print('⚠ Country not found in table')
          "

